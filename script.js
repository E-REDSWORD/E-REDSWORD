// ØªÙ‡ÙŠØ¦Ø© Firebase
const db = firebase.firestore();

// Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
const mainHeader = document.querySelector('.main-header');
const pageTitle = document.getElementById('page-title');
const gameContainer = document.getElementById('game-list');
const categoriesList = document.getElementById('categories-list');
const siteLockedOverlay = document.getElementById('site-locked-overlay');
const sitePasswordForm = document.getElementById('site-password-form');
const gameLockedOverlay = document.getElementById('game-locked-overlay');
const gamePasswordForm = document.getElementById('game-password-form');

let allGames = []; // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ù…Ø¤Ù‚ØªØ§Ù‹

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹
function loadSiteContent() {
    // Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹
    db.collection("settings").doc("site-info").get().then((doc) => {
        if (doc.exists) {
            const data = doc.data();
            mainHeader.querySelector('.logo h1').textContent = data.title;
            pageTitle.textContent = data.description;
            document.body.style.backgroundImage = `url(${data.backgroundImage})`;
            document.title = data.title;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
            if (data.isSiteLocked && !sessionStorage.getItem('siteUnlocked')) {
                siteLockedOverlay.style.display = 'flex';
                sitePasswordForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const password = sitePasswordForm['site-password-input'].value;
                    if (password === data.sitePassword) {
                        sessionStorage.setItem('siteUnlocked', 'true');
                        siteLockedOverlay.style.display = 'none';
                        loadGameList(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ ÙØªØ­ Ø§Ù„Ù‚ÙÙ„
                    } else {
                        alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!');
                    }
                });
                return;
            }
        }
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ÙØªÙˆØ­Ø§Ù‹ØŒ Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨
        loadGameList();
    });
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨
function loadGameList() {
    db.collection("games").get().then((querySnapshot) => {
        allGames = []; // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨
        querySnapshot.forEach((doc) => {
            const game = { id: doc.id, ...doc.data() };
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù…Ø±Ø¦ÙŠØ© ÙÙ‚Ø·
            if (game.isVisible) {
                allGames.push(game);
            }
        });
        displayGames(allGames);
    });
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ ÙÙŠ Ø§Ù„ØµÙØ­Ø©
function displayGames(gamesToShow) {
    gameContainer.innerHTML = '';
    gamesToShow.forEach((game) => {
        const gameElement = document.createElement('div');
        gameElement.className = 'game-card';
        
        const lockIcon = game.isLocked ? '<span class="lock-icon">ğŸ”’</span>' : '';

        gameElement.innerHTML = `
            ${lockIcon}
            <img src="${game.image}" alt="${game.name}">
            <h3>${game.name}</h3>
        `;
        gameElement.addEventListener('click', () => {
            if (game.isLocked && !sessionStorage.getItem(`gameUnlocked-${game.id}`)) {
                gameLockedOverlay.style.display = 'flex';
                gamePasswordForm['game-password-input'].value = '';
                gamePasswordForm.replaceWith(gamePasswordForm.cloneNode(true));
                const newGamePasswordForm = document.getElementById('game-password-form');
                newGamePasswordForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const password = newGamePasswordForm['game-password-input'].value;
                    if (password === game.gamePassword) {
                        sessionStorage.setItem(`gameUnlocked-${game.id}`, 'true');
                        newGamePasswordForm.parentElement.style.display = 'none';
                        window.location.href = `game.html?id=${game.id}`;
                    } else {
                        alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!');
                    }
                });
            } else {
                window.location.href = `game.html?id=${game.id}`;
            }
        });
        gameContainer.appendChild(gameElement);
    });
}

// Ø¯Ø§Ù„Ø© Ù„ØªØµÙÙŠØ© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
function filterGames(category) {
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ù† ÙƒÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
    document.querySelectorAll('#categories-list a').forEach(link => {
        link.classList.remove('active-category');
    });
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø°ÙŠ ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡
    document.querySelector(`[data-category="${category}"]`).classList.add('active-category');
    
    let filteredGames = [];
    if (category === 'all') {
        filteredGames = allGames;
    } else {
        filteredGames = allGames.filter(game => game.category === category);
    }
    displayGames(filteredGames);
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ÙØ¦Ø§Øª
document.querySelectorAll('#categories-list a').forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        const category = e.target.getAttribute('data-category');
        filterGames(category);
    });
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
loadSiteContent();
